<!-- 
  HYTELE LAUNCHER & BETA GAME - PHYSICS UPDATE
  --------------------------------------------
  Changelog:
  - Mundo S√≥lido: Terreno gerado em colunas (sem buracos/cavernas).
  - F√≠sica Corrigida: Colis√£o precisa (Jogador anda sobre os blocos sem atravessar).
  - Mantido: Launcher Hytele, C√¢mera Livre, √Årvores completas.
-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Hytele Launcher</title>
    <style>
        /* =========================================
           CSS GERAL & LAUNCHER (MANTIDO)
           ========================================= */
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #2d2d2d;
            --bg-panel-hover: #3a3a3a;
            --accent-blue: #3b85d9;
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --font-stack: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        
        body {
            font-family: var(--font-stack);
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
        }

        /* --- LAUNCHER UI --- */
        #launcher-root {
            display: flex; flex-direction: column; height: 100%; width: 100%;
            position: absolute; top: 0; left: 0; z-index: 10;
            background: var(--bg-dark); transition: opacity 0.5s;
        }

        .window-bar { height: 32px; background: #111; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; -webkit-app-region: drag; }
        .window-title { font-size: 12px; font-weight: bold; color: #ccc; }
        .win-btn { width: 40px; height: 32px; background: transparent; color: #ccc; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .win-btn:hover { background: #333; }
        .win-btn.close:hover { background: #d32f2f; }

        .app-container { display: flex; flex: 1; overflow: hidden; position: relative; }
        .sidebar { width: 250px; background: rgba(30, 30, 30, 0.95); display: flex; flex-direction: column; border-right: 1px solid #484848; }
        .nav-item { padding: 12px 20px; color: var(--text-muted); cursor: pointer; border-left: 4px solid transparent; display:flex; align-items:center; gap:10px; transition:0.2s; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color:white; }
        .nav-item.active { color: white; background: rgba(255,255,255,0.1); border-left-color: var(--accent-blue); }
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

        .content-tabs { display: flex; justify-content: center; background: rgba(0,0,0,0.5); padding: 10px 0; gap: 20px; backdrop-filter: blur(5px); }
        .tab-btn { background: transparent; color: var(--text-muted); font-size: 14px; text-transform: uppercase; font-weight: bold; border:none; cursor:pointer; padding-bottom: 5px; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: white; border-bottom-color: white; }

        .view-panel { display: none; flex: 1; overflow-y: auto; padding: 20px; padding-bottom:100px; animation: fadeIn 0.3s; }
        .view-panel.active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .news-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top:20px; }
        .news-card { background: var(--bg-panel); border-radius: 4px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .news-card:hover { transform: translateY(-4px); background: var(--bg-panel-hover); }
        .news-img { height: 150px; background: #000; display:flex; align-items:center; justify-content:center; color:#555; font-weight:bold; font-size:20px; }
        .news-content { padding: 15px; }
        .news-tag { font-size: 10px; background: var(--accent-blue); padding: 2px 6px; border-radius: 2px; text-transform: uppercase; font-weight: bold; }
        .news-title { margin: 8px 0; font-size: 16px; font-weight: bold; }

        .bottom-action-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 90px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); display: flex; align-items: center; justify-content: center; z-index: 5; }
        .play-wrapper { display: flex; background: var(--accent-blue); border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .play-btn { background: transparent; color: white; font-size: 24px; font-weight: bold; padding: 15px 40px; text-transform: uppercase; border:none; cursor:pointer; }
        .play-btn:hover { background: rgba(255,255,255,0.1); }
        .version-selector { width: 250px; background: rgba(0,0,0,0.3); padding: 10px; cursor: pointer; border-left: 1px solid rgba(0,0,0,0.2); display: flex; flex-direction: column; justify-content: center; }
        .version-selector:hover { background: rgba(0,0,0,0.5); }

        .progress-container { position: absolute; bottom: 10px; width: 60%; display: none; flex-direction: column; align-items: center; }
        .progress-bar-bg { width: 100%; height: 6px; background: #444; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-bar-fill { height: 100%; width: 0%; background: var(--accent-blue); transition: width 0.2s; }

        .install-item { display: flex; align-items: center; background: var(--bg-panel); padding: 15px; margin-bottom: 10px; border-radius: 4px; transition:0.2s; }
        .install-item:hover { background: var(--bg-panel-hover); }
        .install-icon { width:40px; height:40px; background:#444; margin-right:15px; display:flex; align-items:center; justify-content:center; font-size:20px; }
        
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; display:none; align-items:center; justify-content:center; backdrop-filter:blur(3px); }
        .modal-box { background: #222; width: 400px; padding: 25px; border-radius: 8px; border: 1px solid #444; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: #aaa; font-size: 13px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; background: #111; border: 1px solid #444; color: white; border-radius: 4px; }
        .btn-small { padding: 6px 12px; border-radius: 4px; background: #444; color: white; font-size: 12px; border:none; cursor:pointer; }
        .btn-primary { background: var(--accent-blue); color: white; padding: 8px 16px; border-radius: 4px; border:none; cursor:pointer; font-weight:bold; }

        #bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.3; }

        /* =========================================
           GAME CSS (HYTELE 3D)
           ========================================= */
        #game-root { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200; }
        #gl { display: block; width: 100%; height: 100%; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #game-root * { user-select: none; -webkit-user-select: none; }

        #crosshair { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; transform: translate(-50%, -50%); }
        #crosshair::before, #crosshair::after { content: ''; position: absolute; background: rgba(255,255,255,0.8); }
        #crosshair::before { top: 9px; left: 0; width: 20px; height: 2px; }
        #crosshair::after { top: 0; left: 9px; width: 2px; height: 20px; }

        #hotbar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 4px; pointer-events: auto; }
        .slot { width: 40px; height: 40px; background: rgba(0,0,0,0.5); border: 2px solid #555; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold; cursor:pointer; position: relative; }
        .slot.active { border-color: white; background: rgba(100,100,100,0.5); transform: scale(1.1); }
        .slot img { width:80%; height:80%; image-rendering:pixelated; }
        .slot span { position: absolute; bottom: 2px; right: 2px; text-shadow: 1px 1px 0 #000; }

        .touch-zone { position: absolute; bottom: 80px; width: 140px; height: 140px; pointer-events: auto; border-radius: 50%; border: 2px solid rgba(255,255,255,0.1); display: none; }
        #btn-jump { position: absolute; bottom: 100px; right: 20px; width: 60px; height: 60px; background: rgba(100,100,100,0.5); border-radius: 50%; display: none; pointer-events: auto; border: 2px solid #fff; }

        #btn-exit-game {
            position: absolute; top: 15px; left: 15px; width: 40px; height: 40px;
            background: #d32f2f; border: 2px solid #fff; color: white; font-weight: bold; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; pointer-events: auto; z-index: 300;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #btn-exit-game:hover { background: #b71c1c; }

        #inventory-screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); pointer-events: auto; flex-direction: column; align-items: center; justify-content: center; z-index: 300; }
        #crafting-area { background: #333; padding: 20px; border: 2px solid #fff; margin-bottom: 20px; width: 80%; max-width: 400px; }
        .craft-btn { display: block; width: 100%; padding: 10px; margin: 5px 0; background: #555; color: white; border: 1px solid #888; cursor: pointer; text-align: left; }
        .close-btn { margin-top: 20px; padding: 10px 30px; background: #a00; color: white; border: none; font-size: 16px; cursor: pointer; }
        #btn-inv { position: absolute; top: 15px; right: 15px; width: 40px; height: 40px; background: #999; border: 2px solid #fff; font-size: 24px; display: flex; align-items: center; justify-content: center; pointer-events: auto; cursor: pointer; color: #fff; text-shadow: 1px 1px 0 #000; }

        #stats-debug { position: absolute; top: 15px; left: 70px; color: white; font-family: monospace; text-shadow: 1px 1px 0 #000; font-size:12px; pointer-events:none;}

        @media (hover: none) and (pointer: coarse) {
            .touch-zone, #btn-jump { display: block; }
            #hotbar { bottom: 10px; }
            .slot { width: 32px; height: 32px; }
        }
    </style>
</head>
<body>

<div id="launcher-root">
    <canvas id="bg-canvas"></canvas>

    <div class="window-bar">
        <div class="window-title"><span style="color:var(--accent-blue)">‚ñ†</span> Hytele Launcher</div>
        <div class="window-controls">
            <button class="win-btn">_</button>
            <button class="win-btn">‚ñ°</button>
            <button class="win-btn close" onclick="window.close()">X</button>
        </div>
    </div>

    <div class="app-container">
        <nav class="sidebar">
            <div class="nav-item active" onclick="Launcher.nav('view-play')">
                <span>‚öîÔ∏è</span> Hytele Beta Edition
            </div>
            <div class="nav-item" onclick="Launcher.nav('view-installations')">
                <span>üìÇ</span> Instala√ß√µes
            </div>
            <div class="nav-item" onclick="Launcher.nav('view-skins')">
                <span>üëï</span> Skins
            </div>
            <div class="nav-item" onclick="Launcher.nav('view-settings')">
                <span>‚öôÔ∏è</span> Configura√ß√µes
            </div>
            <div style="margin-top:auto; padding:20px; border-top:1px solid #444; color:#ccc; display:flex; align-items:center; gap:10px">
                <div style="width:24px;height:24px;background:#555;border-radius:50%"></div>
                <span id="user-display">Adventurer</span>
            </div>
        </nav>

        <main class="main-content">
            <div class="content-tabs">
                <button class="tab-btn active" onclick="Launcher.switchTab(this, 'view-play')">Jogar</button>
                <button class="tab-btn" onclick="Launcher.switchTab(this, 'view-installations')">Instala√ß√µes</button>
                <button class="tab-btn" onclick="Launcher.switchTab(this, 'view-patch')">Notas de Atualiza√ß√£o</button>
            </div>

            <div id="view-play" class="view-panel active-view">
                <div class="news-grid" id="news-feed"></div>

                <div class="bottom-action-bar">
                    <div class="play-wrapper">
                        <div class="version-selector" onclick="Launcher.nav('view-installations')">
                            <div style="font-size:10px;color:#ddd">Instala√ß√£o atual</div>
                            <div style="font-weight:bold" id="display-version">Carregando...</div>
                        </div>
                        <button class="play-btn" id="btn-play" onclick="Launcher.play()">JOGAR</button>
                    </div>
                    
                    <div class="progress-container" id="progress-area">
                        <div style="display:flex;justify-content:space-between;width:100%;color:#ccc;font-size:12px">
                            <span id="status-msg">Preparando...</span>
                            <span id="status-percent">0%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" id="progress-fill"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-installations" class="view-panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2>Minhas Instala√ß√µes</h2>
                    <button class="btn-primary" onclick="Launcher.openModal('modal-install')">+ Nova Instala√ß√£o</button>
                </div>
                <div id="install-list"></div>
            </div>

            <div id="view-skins" class="view-panel">
                <h2>Biblioteca de Skins</h2>
                <div style="padding:40px; text-align:center; color:#666; border:2px dashed #444; margin-top:20px; border-radius:8px;">
                    Arraste um arquivo .png aqui (Simula√ß√£o)
                </div>
            </div>

             <div id="view-patch" class="view-panel">
                <h2>Notas de Atualiza√ß√£o - Hytele Physics Fix</h2>
                <ul style="margin-left:20px; margin-top:10px; line-height:1.6; color:#ccc">
                    <li><strong>FIX:</strong> Terreno agora √© s√≥lido (sem buracos/void).</li>
                    <li><strong>FIX:</strong> Colis√£o melhorada: imposs√≠vel atravessar blocos.</li>
                    <li><strong>FIX:</strong> C√¢mera com movimento livre ajustado.</li>
                    <li><strong>NEW:</strong> √Årvores completas geradas no mundo.</li>
                </ul>
            </div>

            <div id="view-settings" class="view-panel">
                <h2>Configura√ß√µes</h2>
                <br>
                <div class="install-item">
                    <span>Manter launcher aberto ao iniciar</span>
                    <input type="checkbox" checked style="margin-left:auto; width:20px; height:20px;">
                </div>
                <div class="install-item">
                    <span>Resolu√ß√£o do Jogo</span>
                    <select style="margin-left:auto; width:150px">
                        <option>Autom√°tico</option>
                        <option>1920x1080</option>
                        <option>1280x720</option>
                    </select>
                </div>
                <button class="btn-small" style="background:#d32f2f; margin-top:20px" onclick="Store.reset()">Resetar Tudo</button>
            </div>
        </main>
    </div>
</div>

<div class="modal-overlay" id="modal-install">
    <div class="modal-box">
        <h3 style="color:white; margin-bottom:20px">Nova Instala√ß√£o</h3>
        <div class="input-group">
            <label>Nome</label>
            <input type="text" id="inst-name" placeholder="Ex: Hytele Survival">
        </div>
        <div class="input-group">
            <label>Vers√£o</label>
            <select id="inst-ver">
                <option value="Hytele Beta 1.0">Hytele Beta 1.0</option>
                <option value="Alpha Test">Alpha Test</option>
            </select>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px">
            <button class="btn-small" onclick="Launcher.closeModal('modal-install')">Cancelar</button>
            <button class="btn-primary" onclick="InstallManager.create()">Criar</button>
        </div>
    </div>
</div>

<div id="game-root">
    <canvas id="gl"></canvas>

    <div id="ui-layer">
        <div id="btn-exit-game" onclick="MCGame.stop()" title="Sair para o Launcher">X</div>
        
        <div id="stats-debug">
            HP: <span id="hp">20</span> | FPS: <span id="fps">60</span><br>
            <span id="coords">X:0 Y:0 Z:0</span>
        </div>

        <div id="crosshair"></div>
        <div id="btn-inv" onclick="toggleInventory()">...</div>
        <div id="hotbar"></div>

        <div id="stick-move" class="touch-zone"></div>
        <div id="btn-jump"></div> 
    </div>

    <div id="inventory-screen">
        <h2 style="color:white; margin-bottom:10px;">CRAFTING</h2>
        <div id="crafting-area"></div>
        <button class="close-btn" onclick="toggleInventory()">FECHAR</button>
    </div>
</div>

<script id="vs" type="x-shader/x-vertex">
    attribute vec3 position;
    attribute vec2 uv;
    attribute float light;
    uniform mat4 uPMatrix;
    uniform mat4 uVMatrix;
    uniform mat4 uMMatrix;
    varying vec2 vUV;
    varying float vLight;
    varying float vFog;
    void main() {
        vec4 worldPos = uMMatrix * vec4(position, 1.0);
        gl_Position = uPMatrix * uVMatrix * worldPos;
        vUV = uv;
        vLight = light;
        float dist = length(uVMatrix * worldPos);
        vFog = clamp((dist - 30.0) / 40.0, 0.0, 1.0);
    }
</script>
<script id="fs" type="x-shader/x-fragment">
    precision mediump float;
    varying vec2 vUV;
    varying float vLight;
    varying float vFog;
    uniform sampler2D uTexture;
    uniform vec3 uFogColor;
    void main() {
        vec4 texColor = texture2D(uTexture, vUV);
        if(texColor.a < 0.5) discard;
        vec3 color = texColor.rgb * vLight;
        gl_FragColor = vec4(mix(color, uFogColor, vFog), 1.0);
    }
</script>

<script>
const Store = {
    data: {
        installations: [
            { id: 'def', name: 'Hytele Beta', version: '1.0', icon: 'grass' }
        ],
        selectedId: 'def'
    },
    init() {
        const s = localStorage.getItem('hytele_data');
        if(s) this.data = JSON.parse(s);
        InstallManager.render();
    },
    save() {
        localStorage.setItem('hytele_data', JSON.stringify(this.data));
        InstallManager.render();
    },
    reset() {
        localStorage.removeItem('hytele_data');
        location.reload();
    }
};

const Launcher = {
    isDownloading: false,

    nav(viewId) {
        document.querySelectorAll('.view-panel').forEach(e => e.classList.remove('active-view'));
        document.getElementById(viewId).classList.add('active-view');
        if(viewId === 'view-play') this.switchTab(document.querySelector('.tab-btn'), 'view-play');
    },

    switchTab(btn, targetId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.querySelectorAll('.view-panel').forEach(e => e.classList.remove('active-view'));
        document.getElementById(targetId).classList.add('active-view');
    },

    openModal(id) { document.getElementById(id).style.display = 'flex'; },
    closeModal(id) { document.getElementById(id).style.display = 'none'; },

    play() {
        if(this.isDownloading) return;
        this.startDownloadSim();
    },

    startDownloadSim() {
        this.isDownloading = true;
        const btn = document.getElementById('btn-play');
        const bar = document.getElementById('progress-fill');
        const txt = document.getElementById('status-percent');
        const msg = document.getElementById('status-msg');
        document.getElementById('progress-area').style.display = 'flex';
        btn.disabled = true; btn.innerText = "CANCELAR";
        
        let p = 0;
        const i = setInterval(() => {
            p += Math.random() * 5;
            if(p > 100) p = 100;
            bar.style.width = p + "%";
            txt.innerText = Math.floor(p) + "%";
            
            if(p < 30) msg.innerText = "Baixando Hytele.jar...";
            else if(p < 80) msg.innerText = "Verificando assets...";
            else msg.innerText = "Iniciando mundo...";

            if(p >= 100) {
                clearInterval(i);
                this.launchGame();
            }
        }, 50);
    },

    launchGame() {
        this.isDownloading = false;
        document.getElementById('btn-play').innerText = "JOGAR";
        document.getElementById('btn-play').disabled = false;
        document.getElementById('progress-area').style.display = 'none';
        document.getElementById('launcher-root').style.display = 'none';
        document.getElementById('game-root').style.display = 'block';
        MCGame.start();
    }
};

const InstallManager = {
    create() {
        const name = document.getElementById('inst-name').value || "Nova Instala√ß√£o";
        const ver = document.getElementById('inst-ver').value;
        Store.data.installations.push({ id: 'i'+Date.now(), name, version: ver, icon: 'furnace' });
        Store.save();
        Launcher.closeModal('modal-install');
        Launcher.nav('view-installations');
    },
    select(id) { Store.data.selectedId = id; Store.save(); Launcher.nav('view-play'); },
    delete(id) {
        if(confirm("Deletar esta instala√ß√£o?")) {
            Store.data.installations = Store.data.installations.filter(i => i.id !== id);
            if(Store.data.selectedId === id) Store.data.selectedId = Store.data.installations[0]?.id || null;
            Store.save();
        }
    },
    render() {
        const list = document.getElementById('install-list');
        list.innerHTML = Store.data.installations.map(i => `
            <div class="install-item">
                <div class="install-icon">üì¶</div>
                <div style="flex:1">
                    <div style="font-weight:bold; color:white">${i.name}</div>
                    <div style="font-size:12px; color:#aaa">${i.version}</div>
                </div>
                <button class="btn-primary" onclick="InstallManager.select('${i.id}')">Jogar</button>
                ${i.id!=='def'?`<button class="btn-small" style="background:#d32f2f; margin-left:10px" onclick="InstallManager.delete('${i.id}')">X</button>`:''}
            </div>
        `).join('');
        const sel = Store.data.installations.find(i => i.id === Store.data.selectedId);
        if(sel) document.getElementById('display-version').innerText = `${sel.name} (${sel.version})`;
    },
    loadNews() {
        const n = [{t: "Bem-vindo ao Hytele", img: "‚öîÔ∏è"}, {t: "Update de Aventura", img: "üå≤"}, {t: "Cosm√©ticos Novos", img: "üíé"}];
        document.getElementById('news-feed').innerHTML = n.map(x => `
            <div class="news-card">
                <div class="news-img">${x.img}</div>
                <div class="news-content">
                    <span class="news-tag">Novidade</span>
                    <div class="news-title">${x.t}</div>
                    <div style="color:#aaa; font-size:12px">Clique para ler mais sobre as novidades do Hytele.</div>
                </div>
            </div>
        `).join('');
    }
};

const MCGame = {
    isRunning: false,
    gl: null, canvas: null, prog: null, world: null, player: null, keys: {}, lastTime: 0, isMobile: false,

    start() {
        if(!this.gl) this.init();
        this.isRunning = true;
        this.resize();
        this.loop(0);
        if(!this.isMobile) { this.canvas.requestPointerLock = this.canvas.requestPointerLock || this.canvas.mozRequestPointerLock; this.canvas.requestPointerLock(); }
    },

    stop() {
        this.isRunning = false;
        if(document.exitPointerLock) document.exitPointerLock();
        document.getElementById('game-root').style.display = 'none';
        document.getElementById('launcher-root').style.display = 'flex';
    },

    init() {
        this.canvas = document.getElementById('gl');
        this.gl = this.canvas.getContext('webgl', { alpha: false, antialias: false, depth: true });
        const vs = this.gl.createShader(this.gl.VERTEX_SHADER);
        this.gl.shaderSource(vs, document.getElementById('vs').text); this.gl.compileShader(vs);
        const fs = this.gl.createShader(this.gl.FRAGMENT_SHADER);
        this.gl.shaderSource(fs, document.getElementById('fs').text); this.gl.compileShader(fs);
        this.prog = this.gl.createProgram();
        this.gl.attachShader(this.prog, vs); this.gl.attachShader(this.prog, fs); this.gl.linkProgram(this.prog); this.gl.useProgram(this.prog);

        const tex = this.gl.createTexture();
        this.gl.bindTexture(this.gl.TEXTURE_2D, tex);
        this.gl.texImage2D(this.gl.TEXTURE_2D, 0, this.gl.RGBA, this.gl.RGBA, this.gl.UNSIGNED_BYTE, this.genTexture());
        this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MAG_FILTER, this.gl.NEAREST);
        this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MIN_FILTER, this.gl.NEAREST);

        this.locs = {
            pos: this.gl.getAttribLocation(this.prog, 'position'),
            uv: this.gl.getAttribLocation(this.prog, 'uv'),
            light: this.gl.getAttribLocation(this.prog, 'light'),
            P: this.gl.getUniformLocation(this.prog, 'uPMatrix'),
            V: this.gl.getUniformLocation(this.prog, 'uVMatrix'),
            M: this.gl.getUniformLocation(this.prog, 'uMMatrix'),
            FogC: this.gl.getUniformLocation(this.prog, 'uFogColor')
        };
        this.gl.enableVertexAttribArray(this.locs.pos); this.gl.enableVertexAttribArray(this.locs.uv); this.gl.enableVertexAttribArray(this.locs.light);
        this.gl.enable(this.gl.DEPTH_TEST); this.gl.enable(this.gl.CULL_FACE);
        this.gl.clearColor(0.6, 0.8, 1.0, 1.0); this.gl.uniform3f(this.locs.FogC, 0.6, 0.8, 1.0);

        this.world = new World(); this.world.init();
        this.player = { x: 0, y: 30, z: 0, vx: 0, vy: 0, vz: 0, yaw: 0, pitch: 0, onGround: false, inventory: new Array(9).fill(null).map(()=>({id:0, count:0})), sel: 0 };
        this.player.inventory[0] = {id:3, count:64}; this.player.inventory[1] = {id:6, count:16};
        this.updateInvUI();
        this.setupInputs();
    },

    genTexture() {
        const c = document.createElement('canvas'); c.width=128; c.height=128; const ctx = c.getContext('2d');
        const noise = (r,g,b,v) => { const n=(Math.random()-0.5)*v; return `rgb(${r+n},${g+n},${b+n})`; };
        const draw = (id, fn) => { const tx=(id%8)*16, ty=Math.floor(id/8)*16; for(let y=0;y<16;y++) for(let x=0;x<16;x++) { ctx.fillStyle=fn(x,y); ctx.fillRect(tx+x,ty+y,1,1); } };
        draw(1, ()=>noise(80,180,60,40)); draw(2, ()=>noise(100,70,40,30)); draw(3, (x,y)=>y<4?noise(80,180,60,40):noise(100,70,40,30)); draw(4, ()=>noise(120,120,120,30)); draw(5, ()=>Math.random()<0.2?'#000':'#444'); draw(6, ()=>noise(90,60,30,10)); draw(7, ()=>noise(80,50,20,10)); draw(8, ()=>Math.random()>0.6?'rgba(0,0,0,0)':noise(30,140,30,40)); draw(11, (x,y)=>(x%4===0||y%16===0)?'#4a3016':'#8f6842');
        return c;
    },

    setupInputs() {
        window.addEventListener('resize', () => this.resize());
        window.addEventListener('keydown', e => { if(this.isRunning) this.keys[e.code] = true; });
        window.addEventListener('keyup', e => { if(this.isRunning) this.keys[e.code] = false; });
        document.addEventListener('mousemove', e => {
            if (this.isRunning && document.pointerLockElement === this.canvas) {
                this.player.yaw -= e.movementX * 0.003; this.player.pitch -= e.movementY * 0.003;
                this.player.pitch = Math.max(-1.55, Math.min(1.55, this.player.pitch));
            }
        });
        this.canvas.addEventListener('mousedown', e => {
            if(!this.isRunning) return;
            if(document.pointerLockElement !== this.canvas && !this.isMobile) { this.canvas.requestPointerLock(); return; }
            this.handleAction(e.button === 2 ? 'place' : 'break');
        });
        this.canvas.addEventListener('touchstart', () => { this.isMobile=true; }, {once:true});
        const jumpBtn = document.getElementById('btn-jump');
        jumpBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); this.keys['Space']=true; });
        jumpBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); this.keys['Space']=false; });
        const touchZone = document.getElementById('stick-move');
        window.addEventListener('touchstart', e => {
            if(!this.isRunning) return;
            for(let i=0; i<e.changedTouches.length; i++) {
                const t = e.changedTouches[i];
                if(t.clientX < window.innerWidth/2) {
                    this.moveTouchId = t.identifier; this.moveOrigin = {x:t.clientX, y:t.clientY};
                    touchZone.style.display='block'; touchZone.style.left = t.clientX+'px'; touchZone.style.top = t.clientY+'px';
                }
            }
        });
        window.addEventListener('touchmove', e => {
            if(!this.isRunning) return;
            for(let i=0; i<e.changedTouches.length; i++) {
                const t = e.changedTouches[i];
                if(t.identifier === this.moveTouchId) {
                    const dx = t.clientX - this.moveOrigin.x; const dy = t.clientY - this.moveOrigin.y;
                    this.keys['KeyW'] = dy < -20; this.keys['KeyS'] = dy > 20; this.keys['KeyA'] = dx < -20; this.keys['KeyD'] = dx > 20;
                } else if (t.clientX > window.innerWidth/2) {
                     this.player.yaw -= (t.clientX - (this.lastTouchX||t.clientX)) * 0.01;
                     this.player.pitch -= (t.clientY - (this.lastTouchY||t.clientY)) * 0.01;
                     this.player.pitch = Math.max(-1.55, Math.min(1.55, this.player.pitch));
                     this.lastTouchX = t.clientX; this.lastTouchY = t.clientY;
                }
            }
        });
        window.addEventListener('touchend', e => {
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === this.moveTouchId) {
                    this.moveTouchId = null; this.keys['KeyW']=false; this.keys['KeyS']=false; this.keys['KeyA']=false; this.keys['KeyD']=false; touchZone.style.display='none';
                }
            }
            this.lastTouchX = null;
        });
    },

    resize() { if(this.canvas){ this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; this.gl.viewport(0, 0, this.canvas.width, this.canvas.height); } },

    loop(time) {
        if(!this.isRunning) return;
        const dt = Math.min((time - this.lastTime) / 1000, 0.1); this.lastTime = time;
        this.updatePhysics(dt); this.render();
        requestAnimationFrame(t => this.loop(t));
    },

    updatePhysics(dt) {
        let dx = 0, dz = 0;
        if (this.keys['KeyW']) { dx -= Math.sin(this.player.yaw); dz -= Math.cos(this.player.yaw); }
        if (this.keys['KeyS']) { dx += Math.sin(this.player.yaw); dz += Math.cos(this.player.yaw); }
        if (this.keys['KeyA']) { dx -= Math.cos(this.player.yaw); dz += Math.sin(this.player.yaw); }
        if (this.keys['KeyD']) { dx += Math.cos(this.player.yaw); dz -= Math.sin(this.player.yaw); }
        
        const l = Math.sqrt(dx*dx + dz*dz); if(l > 0) { dx/=l; dz/=l; }
        const speed = 5.0; this.player.vx = dx * speed; this.player.vz = dz * speed; this.player.vy += -24.0 * dt;

        if (this.keys['Space'] && this.player.onGround) { this.player.vy = 9.0; this.player.onGround = false; }

        let nextX = this.player.x + this.player.vx * dt;
        let nextY = this.player.y + this.player.vy * dt;
        let nextZ = this.player.z + this.player.vz * dt;

        // PHYSICS FIX: Solid Ground Check
        const groundHeight = this.world.getHeight(Math.floor(nextX), Math.floor(nextZ));
        const floorY = groundHeight + 1.8; // Player Height

        // Hard collision with floor to prevent falling through
        if (nextY < floorY) {
            this.player.y = floorY;
            this.player.vy = 0;
            this.player.onGround = true;
        } else {
            this.player.y = nextY;
            this.player.onGround = false;
        }

        this.player.x = nextX;
        this.player.z = nextZ;

        document.getElementById('coords').innerText = `X:${Math.floor(this.player.x)} Y:${Math.floor(this.player.y)} Z:${Math.floor(this.player.z)}`;
        document.getElementById('fps').innerText = Math.round(1/dt);
    },

    render() {
        this.gl.clear(this.gl.COLOR_BUFFER_BIT | this.gl.DEPTH_BUFFER_BIT);
        const pMat = new Float32Array(16); const vMat = new Float32Array(16); const aspect = this.canvas.width / this.canvas.height;
        const f = 1.0 / Math.tan(Math.PI/4 / 2), nf = 1 / (0.1 - 100);
        pMat[0] = f / aspect; pMat[5] = f; pMat[10] = (100 + 0.1) * nf; pMat[11] = -1; pMat[14] = (2 * 100 * 0.1) * nf;
        const eye = [this.player.x, this.player.y + 1.6, this.player.z];
        const target = [this.player.x - Math.sin(this.player.yaw) * Math.cos(this.player.pitch), this.player.y + 1.6 + Math.sin(this.player.pitch), this.player.z - Math.cos(this.player.yaw) * Math.cos(this.player.pitch)];
        const up = [0,1,0];
        const z0=eye[0]-target[0], z1=eye[1]-target[1], z2=eye[2]-target[2]; const len = 1/Math.sqrt(z0*z0+z1*z1+z2*z2); const za = [z0*len, z1*len, z2*len];
        const x0=up[1]*za[2]-up[2]*za[1], x1=up[2]*za[0]-up[0]*za[2], x2=up[0]*za[1]-up[1]*za[0]; const lenX = 1/Math.sqrt(x0*x0+x1*x1+x2*x2); const xa = [x0*lenX, x1*lenX, x2*lenX];
        const ya = [za[1]*xa[2]-za[2]*xa[1], za[2]*xa[0]-za[0]*xa[2], za[0]*xa[1]-za[1]*xa[0]];
        vMat[0]=xa[0]; vMat[1]=ya[0]; vMat[2]=za[0]; vMat[3]=0; vMat[4]=xa[1]; vMat[5]=ya[1]; vMat[6]=za[1]; vMat[7]=0; vMat[8]=xa[2]; vMat[9]=ya[2]; vMat[10]=za[2]; vMat[11]=0;
        vMat[12]=-(xa[0]*eye[0]+xa[1]*eye[1]+xa[2]*eye[2]); vMat[13]=-(ya[0]*eye[0]+ya[1]*eye[1]+ya[2]*eye[2]); vMat[14]=-(za[0]*eye[0]+za[1]*eye[1]+za[2]*eye[2]); vMat[15]=1;
        this.gl.uniformMatrix4fv(this.locs.P, false, pMat); this.gl.uniformMatrix4fv(this.locs.V, false, vMat);
        const cx=Math.floor(this.player.x/16), cz=Math.floor(this.player.z/16);
        for(let x=cx-2; x<=cx+2; x++) for(let z=cz-2; z<=cz+2; z++) { this.world.renderChunk(x,0,z, this.gl, this.locs); }
    },

    raycast() {
        let x=this.player.x, y=this.player.y+1.6, z=this.player.z;
        let dx = -Math.sin(this.player.yaw)*Math.cos(this.player.pitch); let dy = Math.sin(this.player.pitch); let dz = -Math.cos(this.player.yaw)*Math.cos(this.player.pitch);
        let px=Math.floor(x), py=Math.floor(y), pz=Math.floor(z);
        for(let i=0; i<6; i+=0.1) {
            x+=dx*0.1; y+=dy*0.1; z+=dz*0.1;
            let ix=Math.floor(x), iy=Math.floor(y), iz=Math.floor(z);
            let b = this.world.getBlock(ix,iy,iz);
            if(b!==0 && b!==undefined) return {hit:true, bx:ix, by:iy, bz:iz, px:px, py:py, pz:pz};
            px=ix; py=iy; pz=iz;
        }
        return {hit:false};
    },

    handleAction(type) {
        const hit = this.raycast();
        if(hit.hit) {
            if(type === 'break') { this.world.setBlock(hit.bx, hit.by, hit.bz, 0); } 
            else {
                const item = this.player.inventory[this.player.sel];
                if(item.id !== 0 && item.count > 0) {
                     const dx = Math.abs((hit.px+0.5)-this.player.x); const dy = Math.abs((hit.py+0.5)-(this.player.y+0.9)); const dz = Math.abs((hit.pz+0.5)-this.player.z);
                     if(dx>0.8 || dy>0.8 || dz>0.8) { this.world.setBlock(hit.px, hit.py, hit.pz, item.id); }
                }
            }
        }
    },

    updateInvUI() {
        const bar = document.getElementById('hotbar'); bar.innerHTML = '';
        this.player.inventory.forEach((it, i) => {
            const d = document.createElement('div'); d.className = 'slot' + (i===this.player.sel ? ' active' : '');
            if(it.id !== 0) { let c='#fff'; if(it.id===3)c='#888'; if(it.id===6)c='#531'; d.innerHTML = `<div style="width:20px;height:20px;background:${c}"></div><span>${it.count}</span>`; }
            d.onclick = () => { this.player.sel=i; this.updateInvUI(); }; bar.appendChild(d);
        });
    }
};

class World {
    constructor() { this.chunks={}; }
    init() {}
    key(cx,cy,cz) { return cx+','+cy+','+cz; }
    getChunk(cx,cy,cz) { const k = this.key(cx,cy,cz); if(!this.chunks[k]) this.gen(cx,cy,cz); return this.chunks[k]; }

    gen(cx,cy,cz) {
        const data = new Uint8Array(4096);
        for(let x=0;x<16;x++) for(let z=0;z<16;z++) {
            const wx=cx*16+x, wz=cz*16+z;
            const h = Math.floor(Math.sin(wx*0.1)*4 + Math.cos(wz*0.1)*4 + 10);
            for(let y=0;y<16;y++) {
                const wy=cy*16+y;
                let id=0;
                // FILL TERRAIN: No Holes. If y <= height, it is solid.
                if(wy <= h) {
                    if(wy===0) id=5; // Bedrock
                    else if(wy<h-3) id=4; // Stone
                    else if(wy<h) id=2; // Dirt
                    else id=1; // Grass
                }
                data[x+y*16+z*256] = id;
            }
            // Trees
            if(x===8 && z===8) {
                const groundY = h; const localY = groundY - (cy*16);
                if(localY >= 0 && localY < 12) {
                    for(let i=1; i<=5; i++) { if(localY+i < 16) data[x+(localY+i)*16+z*256] = 6; }
                    for(let ly=3; ly<=4; ly++) {
                        for(let lx=-2; lx<=2; lx++) for(let lz=-2; lz<=2; lz++) {
                            if(lx===0 && lz===0) continue; 
                            const fX = x+lx; const fZ = z+lz; const fY = localY+ly;
                            if(fX>=0 && fX<16 && fZ>=0 && fZ<16 && fY<16) { if(data[fX+fY*16+fZ*256] === 0) data[fX+fY*16+fZ*256] = 8; }
                        }
                    }
                }
            }
        }
        this.chunks[this.key(cx,cy,cz)] = { data, mesh:null, dirty:true };
    }

    getBlock(x,y,z) {
        const cx=Math.floor(x/16), cy=Math.floor(y/16), cz=Math.floor(z/16);
        if(cy<0||cy>3) return 0;
        const c = this.getChunk(cx,cy,cz);
        const lx=x%16, ly=y%16, lz=z%16;
        return c.data[(lx<0?lx+16:lx) + (ly<0?ly+16:ly)*16 + (lz<0?lz+16:lz)*256];
    }

    setBlock(x,y,z,id) {
        const cx=Math.floor(x/16), cy=Math.floor(y/16), cz=Math.floor(z/16);
        const c = this.getChunk(cx,cy,cz);
        const lx=x%16, ly=y%16, lz=z%16;
        const idx = (lx<0?lx+16:lx) + (ly<0?ly+16:ly)*16 + (lz<0?lz+16:lz)*256;
        c.data[idx] = id; c.dirty=true;
    }
    
    // Helper for Physics Hard Floor
    getHeight(x,z) { return Math.floor(Math.sin(x*0.1)*4 + Math.cos(z*0.1)*4 + 10); }

    renderChunk(cx,cy,cz,gl,locs) {
        const c = this.getChunk(cx,cy,cz);
        if(c.dirty || !c.mesh) this.mesh(c);
        if(c.mesh && c.mesh.cnt>0) {
            const m = new Float32Array([1,0,0,0, 0,1,0,0, 0,0,1,0, cx*16,cy*16,cz*16,1]);
            gl.uniformMatrix4fv(locs.M, false, m);
            gl.bindBuffer(gl.ARRAY_BUFFER, c.mesh.pos); gl.vertexAttribPointer(locs.pos, 3, gl.FLOAT, false, 0, 0);
            gl.bindBuffer(gl.ARRAY_BUFFER, c.mesh.uv); gl.vertexAttribPointer(locs.uv, 2, gl.FLOAT, false, 0, 0);
            gl.bindBuffer(gl.ARRAY_BUFFER, c.mesh.light); gl.vertexAttribPointer(locs.light, 1, gl.FLOAT, false, 0, 0);
            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, c.mesh.idx); gl.drawElements(gl.TRIANGLES, c.mesh.cnt, gl.UNSIGNED_SHORT, 0);
        }
    }

    mesh(c) {
        const pos=[], uv=[], light=[], idx=[]; let i=0;
        const add = (p,u,l) => { pos.push(...p); uv.push(...u); light.push(...l); idx.push(i,i+1,i+2,i,i+2,i+3); i+=4; };
        const UV = (id, face) => {
            let t=1;
            if(id===1) t = face===1?1: (face===0?2:3); else if(id===2) t=2; else if(id===4) t=4; else if(id===5) t=5; else if(id===6) t=6; else if(id===9) t=11; else if(id===8) t=8;
            if(id===6 && (face===1 || face===0)) t=7; 
            const u=(t%8)/8, v=Math.floor(t/8)/8, s=1/8; return [u, v+s, u+s, v+s, u+s, v, u, v];
        };
        for(let x=0; x<16; x++) for(let y=0; y<16; y++) for(let z=0; z<16; z++) {
            const id = c.data[x+y*16+z*256];
            if(id===0) continue;
            const solid = (dx,dy,dz) => {
                const nx=x+dx, ny=y+dy, nz=z+dz;
                if(nx<0||nx>15||ny<0||ny>15||nz<0||nz>15) return false; 
                const nid = c.data[nx+ny*16+nz*256]; return nid!==0 && nid!==8;
            }
            if(!solid(0,1,0)) add([x,y+1,z+1, x+1,y+1,z+1, x+1,y+1,z, x,y+1,z], UV(id,1), [1,1,1,1]);
            if(!solid(0,-1,0)) add([x,y,z, x+1,y,z, x+1,y,z+1, x,y,z+1], UV(id,0), [0.5,0.5,0.5,0.5]);
            if(!solid(0,0,1)) add([x,y,z+1, x+1,y,z+1, x+1,y+1,z+1, x,y+1,z+1], UV(id,2), [0.8,0.8,0.8,0.8]);
            if(!solid(0,0,-1)) add([x+1,y,z, x,y,z, x,y+1,z, x+1,y+1,z], UV(id,2), [0.8,0.8,0.8,0.8]);
            if(!solid(1,0,0)) add([x+1,y,z+1, x+1,y,z, x+1,y+1,z, x+1,y+1,z+1], UV(id,2), [0.6,0.6,0.6,0.6]);
            if(!solid(-1,0,0)) add([x,y,z, x,y,z+1, x,y+1,z+1, x,y+1,z], UV(id,2), [0.6,0.6,0.6,0.6]);
        }
        const buf = (d,t) => { const b=MCGame.gl.createBuffer(); MCGame.gl.bindBuffer(t,b); MCGame.gl.bufferData(t,d,MCGame.gl.STATIC_DRAW); return b; };
        c.mesh = {
            pos: buf(new Float32Array(pos), MCGame.gl.ARRAY_BUFFER), uv: buf(new Float32Array(uv), MCGame.gl.ARRAY_BUFFER), light: buf(new Float32Array(light), MCGame.gl.ARRAY_BUFFER), idx: buf(new Uint16Array(idx), MCGame.gl.ELEMENT_ARRAY_BUFFER), cnt: idx.length
        };
        c.dirty=false;
    }
}
function toggleInventory() { const s = document.getElementById('inventory-screen'); s.style.display = s.style.display==='flex'?'none':'flex'; if(s.style.display==='flex') { if(document.exitPointerLock) document.exitPointerLock(); renderCrafting(); } else { if(!MCGame.isMobile) document.getElementById('gl').requestPointerLock(); } }
function renderCrafting() { document.getElementById('crafting-area').innerHTML = `<button class="craft-btn" onclick="craft()">Craft: Madeira -> T√°buas</button>`; }
function craft() { const inv = MCGame.player.inventory; const log = inv.find(i=>i.id===6 && i.count>0); if(log) { log.count--; if(log.count===0) log.id=0; const plank = inv.find(i=>i.id===9); if(plank) plank.count+=4; else { const e=inv.find(i=>i.id===0); if(e){e.id=9;e.count=4;} } MCGame.updateInvUI(); } }
const bgC = document.getElementById('bg-canvas'); const bgCtx = bgC.getContext('2d'); const particles = Array.from({length:50}, ()=>({x:Math.random()*window.innerWidth, y:Math.random()*window.innerHeight, s:Math.random()*3+1, v:Math.random()*0.5+0.1}));
function bgLoop() { bgC.width=window.innerWidth; bgC.height=window.innerHeight; bgCtx.clearRect(0,0,bgC.width,bgC.height); bgCtx.fillStyle='rgba(255,255,255,0.1)'; particles.forEach(p=>{ p.y-=p.v; if(p.y<0)p.y=bgC.height; bgCtx.beginPath(); bgCtx.arc(p.x,p.y,p.s,0,Math.PI*2); bgCtx.fill(); }); requestAnimationFrame(bgLoop); }
bgLoop();
Store.init(); InstallManager.loadNews();
</script>
</body>
</html>